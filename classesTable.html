<!DOCTYPE html>
<html lang="ja">
    <head>
        <!-- GoogleTag -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-0CL1H2HGPL"></script>
        <script>
            window.dataLayer = window.dataLayer || [];
            function gtag() {
                dataLayer.push(arguments);
            }
            gtag("js", new Date());
            gtag("config", "G-0CL1H2HGPL");
        </script>

        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link rel="icon" href="/favicon.ico" />
        <script src="/theme.js"></script>
        <link rel="stylesheet" href="/style.css" />
        <meta property="og:site_name" content="がくそん" />
        <title>時間割表 - がくそん</title>
        <meta property="og:title" content="時間割表 - がくそん" />
        <meta name="description" content="時間割表のページです。" />
        <meta property="og:description" content="時間割表のページです。" />
    </head>
    <body>
        <header></header>
        <script>
            (async () => {
                const res = await fetch("/header.html");
                document.querySelector("header").innerHTML = await res.text();
            })();
        </script>

        <!-- ここより下に書いてください -->
        <style>
            #timetable-container {
                margin: 3em 0;
            }
            #timetable {
                border-collapse: collapse;
                margin: auto;
                width: min(94%, 1200px);
                text-align: center;
                table-layout: fixed;
                font-size: min(3vw, 1rem);
            }
            td,
            th {
                width: 18%;
                height: 7em;
                border: 1px solid var(--pColor);
                overflow-wrap: anywhere;
                padding: 0.1em;
            }
            td {
                cursor: pointer;
            }
            th {
                height: 3em;
            }
            .period {
                width: 3vw;
            }
            span.room {
                display: block;
                margin: 1em 1em 0 1em;
                border-radius: 1em;
                padding: 0.2em 0;
                background: var(--pColor);
                color: var(--bgColor);
            }
            input {
                padding: 0.4em 1em;
                border: 2px solid var(--pColor);
                border-radius: 5px;
                background: var(--bgColor);
                color: var(--pColor);
            }
            /* dialogベースのポップアップに置き換え */
            #popup {
                background: var(--bgColor);
                color: var(--pColor);
                padding: 20px;
                z-index: 1000;
                border: none;
                border-radius: 8px;
                width: min(90%, 30rem);
                box-sizing: border-box;
            }
            dialog::backdrop {
                background: #888888cc;
            }
            .btn {
                margin: 5px;
                padding: 5px 10px;
                border: none;
                cursor: pointer;
            }
            .register {
                background-color: #4caf50;
                color: white;
            }
            .update {
                background-color: #2196f3;
                color: white;
            }
            .delete {
                background-color: #f44336;
                color: white;
            }
        </style>
        <h1>時間割</h1>
        <p style="text-align: center">データはCookieに保存されています。ブラウザデータを削除するとこれも消えます。</p>
        <div id="timetable-container">
            <table id="timetable">
                <thead>
                    <tr>
                        <th class="period"></th>
                        <th>月</th>
                        <th>火</th>
                        <th>水</th>
                        <th>木</th>
                        <th>金</th>
                    </tr>
                </thead>
                <tbody id="timetableBody"></tbody>
            </table>
        </div>

        <dialog id="popup">
            <label>授業名&ensp; <input type="text" id="subject" /></label><br /><br />
            <label>教室&emsp;&ensp; <input type="text" id="room" /></label><br /><br />
            <div id="buttons"></div>
        </dialog>

        <script>
            function isValidRoom(room) {
                /*
                const rules = {
                    B: [],
                    D: [],
                    E: [],
                    F: [],
                    G: [],
                    H: [],
                    K: [],
                    L: [],
                    M: ["B1", "B2", 1, 2],
                    Q: [],
                    R: [31, 32, 33, 34, 35, 36, 41, 42, 43, 44, 45, 46, 47, 48, 49, 51, 52, 53, 54, 55, 56, 57, 58, 61, 62, 63, 64, 65, 66, 67, 68],
                    S: [21, 22, 23, 31, 32, 41, 42, 43, 44, 45, 46, 47, 48, 51, 52, 53, 54, 55, 56, 57, 58, 61, 62, 63, 64, 65, 66, 67, 68, 70, 71, 72, 73],
                    T: [201, 202],
                };
                const reType1 = /^([A-Z])(\d+)$/;
                const reType2 = /^([A-Z])B(\d+)$/;
                let match;
                //地上教室
                if ((match = room.match(reType1))) {
                    const [, letter, numStr] = match;
                    const num = Number(numStr);
                    if (Array.isArray(rules[letter]) && rules[letter].includes(num)) {
                        return true;
                    }
                    return false;
                }
                // 地下教室
                if ((match = room.match(reType2))) {
                    const [, letter, numStr] = match;
                    const code = `B${numStr}`;
                    if (Array.isArray(rules[letter]) && rules[letter].includes(code)) {
                        return true;
                    }
                    return false;
                }
                // 教室じゃない
                return true;
                */
                // 教室データを実装するまではすべての入力を有効とする
                return true;
            }

            const timetable = document.getElementById("timetableBody");
            const popup = document.getElementById("popup");
            let currentCell = null;
            let popupClickHandler = null;

            // ダイアログが閉じられたときのクリーンアップ
            popup.addEventListener("close", () => {
                if (popupClickHandler) {
                    popup.removeEventListener("click", popupClickHandler);
                    popupClickHandler = null;
                }
            });
            // 時間割を初期化
            for (let period = 1; period <= 5; period++) {
                const row = timetable.insertRow();
                row.appendChild(document.createElement("th")).textContent = `${period}`;
                for (let day = 0; day < 5; day++) {
                    const cell = row.insertCell();
                    const key = `timetable-${day}-${period}`;
                    const data = getCellData(key);
                    if (data) cell.innerHTML = `${data.subject}<br><span class="room">${data.room || "&ensp;"}</span>`;
                    cell.addEventListener("click", () => openPopup(cell, key));
                }
            }

            // ポップアップを表示
            function openPopup(cell, key) {
                currentCell = { cell, key };
                const data = getCellData(key);
                document.getElementById("subject").value = data ? data.subject : "";
                document.getElementById("room").value = data ? data.room : "";
                const buttons = document.getElementById("buttons");
                buttons.innerHTML = "";

                if (data) {
                    const updBtn = document.createElement("button");
                    updBtn.textContent = "更新";
                    updBtn.className = "btn update";
                    updBtn.onclick = saveData;
                    buttons.appendChild(updBtn);

                    const delBtn = document.createElement("button");
                    delBtn.textContent = "削除";
                    delBtn.className = "btn delete";
                    delBtn.type = "button";
                    delBtn.onclick = () => {
                        if (confirm("本当に削除しますか？")) deleteData();
                    };
                    buttons.appendChild(delBtn);
                } else {
                    const regBtn = document.createElement("button");
                    regBtn.textContent = "登録";
                    regBtn.className = "btn register";
                    regBtn.onclick = saveData;
                    regBtn.type = "button";
                    buttons.appendChild(regBtn);
                }
                const cancelBtn = document.createElement("button");
                cancelBtn.textContent = "キャンセル";
                cancelBtn.className = "btn";
                cancelBtn.type = "button";
                cancelBtn.onclick = closePopup;
                buttons.appendChild(cancelBtn);

                popup.showModal();
                popupClickHandler = (e) => {
                    if (e.target === popup) closePopup();
                };
                popup.addEventListener("click", popupClickHandler);
            }

            function saveData() {
                const subject = document.getElementById("subject").value.trim();
                const room = document.getElementById("room").value.trim();

                if (!isValidRoom(room)) {
                    const proceed = confirm(`${room}教室は存在しません。このまま登録しますか？`);
                    if (!proceed) return;
                }

                const key = currentCell.key;
                document.cookie = `${key}=${encodeURIComponent(JSON.stringify({ subject, room }))}; path=/;`;
                currentCell.cell.innerHTML = `${subject}<br><span class="room">${room || "&ensp;"}</span>`;
                closePopup();
            }

            function deleteData() {
                document.cookie = `${currentCell.key}=; max-age=0; path=/;`;
                currentCell.cell.innerHTML = "";
                closePopup();
            }

            function closePopup() {
                try {
                    if (typeof popup.close === "function" && popup.open) popup.close();
                } catch (e) {
                    popup.style.display = "none";
                }
                if (popupClickHandler) {
                    popup.removeEventListener("click", popupClickHandler);
                    popupClickHandler = null;
                }
            }

            // Cookieからデータ取得
            function getCellData(key) {
                const cookies = document.cookie.split("; ");
                for (let c of cookies) {
                    const [k, v] = c.split("=");
                    if (k === key) {
                        try {
                            return JSON.parse(decodeURIComponent(v));
                        } catch (_) {
                            return null;
                        }
                    }
                }
                return null;
            }
        </script>
        <!-- ここより上に書いてください -->
        <footer></footer>
        <script>
            (async () => {
                const res = await fetch("/footer.html");
                document.querySelector("footer").innerHTML = await res.text();
            })();
        </script>
    </body>
</html>
